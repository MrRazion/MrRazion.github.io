<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Downloader Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #222222);
        }
        
        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 16px;
        }
        
        .download-card {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .file-icon {
            width: 50px;
            height: 50px;
            background: var(--tg-theme-button-color, #40a7e3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .file-icon svg {
            width: 30px;
            height: 30px;
            fill: white;
        }
        
        .file-details h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .file-details p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .progress-percent {
            font-weight: bold;
            color: var(--tg-theme-button-color, #40a7e3);
        }
        
        .progress-bar {
            height: 8px;
            background: var(--tg-theme-section-bg-color, #ebebeb);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--tg-theme-button-color, #40a7e3);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .download-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
        }
        
        .download-btn:disabled {
            background: var(--tg-theme-secondary-bg-color, #cccccc);
            cursor: not-allowed;
        }
        
        .download-btn:not(:disabled):hover {
            background: var(--tg-theme-button-color, #40a7e3);
            opacity: 0.9;
        }
        
        .permission-notice {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-success {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            display: block;
        }
        
        .status-error {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            display: block;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–°–∫–∞—á–∞—Ç—å CrazyMita</h1>
            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É</p>
        </div>
        
        <div class="download-card">
            <div class="file-info">
                <div class="file-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                    </svg>
                </div>
                <div class="file-details">
                    <h2>CrazyMita.zip</h2>
                    <p>–ê—Ä—Ö–∏–≤–Ω—ã–π —Ñ–∞–π–ª ‚Ä¢ –†–∞–∑–º–µ—Ä: ~150 –ú–ë</p>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-info">
                    <span class="progress-text">–°—Ç–∞—Ç—É—Å: <span id="status-text">–ì–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ</span></span>
                    <span class="progress-percent" id="progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <button id="download-btn" class="download-btn">–°–∫–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å</button>
            
            <div id="status-message" class="status-message"></div>
        </div>
        
        <div class="permission-notice">
            <p>üí° –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞.</p>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const downloadBtn = document.getElementById('download-btn');
        const progressFill = document.getElementById('progress-fill');
        const progressPercent = document.getElementById('progress-percent');
        const statusText = document.getElementById('status-text');
        const statusMessage = document.getElementById('status-message');
        
        // URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const DOWNLOAD_URL = 'https://huggingface.co/Zerchi/CrazyMita/resolve/main/CrazyMita.zip';
        const FILE_NAME = 'CrazyMita.zip';
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        let isDownloading = false;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            
            if (percent === 0) {
                statusText.textContent = '–ì–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ';
            } else if (percent < 100) {
                statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞: ' + percent + '%';
            } else {
                statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, isSuccess) {
            statusMessage.textContent = message;
            statusMessage.className = isSuccess ? 
                'status-message status-success' : 
                'status-message status-error';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
        function requestStoragePermission() {
            return new Promise((resolve, reject) => {
                if (tg.isVersionAtLeast('6.1')) {
                    // –î–ª—è –±–æ–ª–µ–µ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π WebApp
                    tg.requestWriteAccess()
                        .then(() => resolve(true))
                        .catch(() => resolve(false));
                } else {
                    // –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
                    try {
                        tg.showPopup({
                            title: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è',
                            message: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—é —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø?',
                            buttons: [
                                {type: 'ok', text: '–†–∞–∑—Ä–µ—à–∏—Ç—å'},
                                {type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                            ]
                        }, (buttonId) => {
                            resolve(buttonId === 'ok');
                        });
                    } catch (e) {
                        // –ï—Å–ª–∏ popup –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å
                        resolve(true);
                    }
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        async function downloadFile() {
            if (isDownloading) return;
            
            isDownloading = true;
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<span class="loader"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                statusText.textContent = '–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...';
                const hasPermission = await requestStoragePermission();
                
                if (!hasPermission) {
                    showStatus('–î–æ—Å—Ç—É–ø –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª.', false);
                    isDownloading = false;
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å';
                    return;
                }
                
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏...';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ downloadFile –∏–∑ Telegram WebApp API
                if (tg.platform !== 'unknown' && tg.downloadFile) {
                    tg.downloadFile(DOWNLOAD_URL, FILE_NAME);
                    
                    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã Telegram)
                    tg.onEvent('downloadProgress', (data) => {
                        if (data.url === DOWNLOAD_URL) {
                            const percent = Math.round((data.loaded / data.total) * 100);
                            updateProgress(percent);
                        }
                    });
                    
                    tg.onEvent('downloadComplete', (data) => {
                        if (data.url === DOWNLOAD_URL) {
                            updateProgress(100);
                            showStatus('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –≤–∞—à–µ–π –≥–∞–ª–µ—Ä–µ–µ/–∑–∞–≥—Ä—É–∑–∫–∞—Ö!', true);
                            isDownloading = false;
                            downloadBtn.disabled = false;
                            downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –µ—â–µ —Ä–∞–∑';
                        }
                    });
                    
                    tg.onEvent('downloadFailed', (data) => {
                        if (data.url === DOWNLOAD_URL) {
                            showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), false);
                            updateProgress(0);
                            isDownloading = false;
                            downloadBtn.disabled = false;
                            downloadBtn.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
                        }
                    });
                    
                } else {
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç downloadFile
                    showStatus('–í–∞—à–∞ –≤–µ—Ä—Å–∏—è Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ. –û—Ç–∫—Ä—ã–≤–∞—é —Å—Å—ã–ª–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.', true);
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                    tg.openLink(DOWNLOAD_URL);
                    
                    isDownloading = false;
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å';
                }
                
            } catch (error) {
                console.error('Download error:', error);
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, false);
                isDownloading = false;
                downloadBtn.disabled = false;
                downloadBtn.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        downloadBtn.addEventListener('click', downloadFile);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        tg.ready();
        updateProgress(0);
    </script>
</body>
</html>
